<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    
    <head>
   <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-106786912-1">
    </script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments)};
      gtag('js', new Date());
      gtag('config', 'UA-106786912-1');
    </script>


     <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
 <!--
      loads the http over https ssl -
      welcome to my website!

	this theme is based off the Ice & Fire theme created by Lucas Gatsas
      https://www.twitter.com/LucasGatsas
      www.lucasgatsas.ch - switzerland.
  -->


<!-- Microsoft Internet Explorer documentMode compatMode setting IE Modus -->
<script type="text/javascript">
var IE = null;
if (window.navigator.appName == "Microsoft Internet Explorer") {
  if (document.documentMode) {

    IE = document.documentMode;
    } else {

        IE = 5;
          if (document.compatMode) {
      if (document.compatMode == "CSS1Compat")
      IE = 11;
      }
    }
  }
</script>

    <meta charset="utf-8">
    <!-- X-UA -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <link rel="author" title="Ranjit Jhala" href="http://ranjitjhala.github.io" />

    <meta name="google" content="notranslate" />
    <!-- Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- index ROBOTS follow -->
    <meta name="robots" content="index, follow" />
    <!-- Site Desciption -->
    <meta name="description" content="LiquidHaskell Blog">
    <!-- Site Desciption -->
    <meta name="keywords" content="haskell, refinement types, liquid types, formal methods, type systems">
    <!-- Favicon -->
    <link rel="shortcut icon" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/ico.png" type="image/x-icon" />
    <!-- Blog Title -->
    <title>LiquidHaskell</title>

    <!--     <title>{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
-->
    <!-- Property Metas -->
    <meta property="og:image" content="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/ix.png" />
    <meta property="og:title" content="LiquidHaskell Blog" />
    <meta property="og:site_name" content="LiquidHaskell Blog" />
    <!-- Canonical -->
    <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseUrl | prepend: site.url }}">
    <!-- StyleSheet -->
    <link rel="stylesheet" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/css/spaceg.stylesheets.css"> -->
    <link rel="stylesheet" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/css/ronacher.css" type="text/css">

    <link rel="stylesheet" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/css/syntax.css">
    <link rel="stylesheet" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/css/liquid-light.css">

    <!-- Fonts
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,900,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
	#preloader {position:fixed;top:0;left:0;right:0;bottom:0;background-color:#fff; /* change if the mask should have another color then white */z-index:99; /* makes sure it stays on top */}
	#status {width:200px;height:200px;position:absolute;left:50%; /* centers the loading animation horizontally one the screen */top:50%; /* centers the loading animation vertically one the screen */background-image:url("/static/img/preloader.gif"); /* path to your loading animation */background-repeat:no-repeat;background-position:center;margin:-100px 0 0 -100px; /* is width and height divided by two */}
	ul, ol {margin-top: 0;margin-bottom: 10px;}
	.navbar-inverse {background-color: #FFF;border-color: #FFFFFF;}
</style>
<!--link rel="stylesheet" href="https://ucsd-progsys.github.io/liquidhaskell-blog/static/css/prettify.css"-->
<style>
  /* HEADER IMAGE */
  header.intro-header {background: #6f5499;background: no-repeat center center;background-attachment: scroll;-webkit-background-size: cover;-moz-background-size: cover;background-size: cover;-o-background-size: cover;}

	/* Preloader */#preloader {position:fixed;top:0;left:0;right:0;bottom:0;background-color:#fff; /* change if the mask should have another color then white */z-index:99; /* makes sure it stays on top */}
	#status {width:200px;height:200px;position:absolute;left:50%; /* centers the loading animation horizontally one the screen */top:50%; /* centers the loading animation vertically one the screen */background-image:; /* path to your loading animation */background-repeat:no-repeat;background-position:center;margin:-100px 0 0 -100px; /* is width and height divided by two */}
	li {list-style: none;}
            body.modal-open
            {overflow: hidden;padding-right: 0px;
        }
	article li {list-style: inherit;}
	article .figure {text-align: center}
    </style>
    <!-- end Loading front stylesheet here -->

    <link href="atom.xml" type="application/atom+xml" rel="alternate" title="LiquidHaskell-Blog ATOM Feed" />
    </head>

    <body>
	    
	<!-- 	
        <div id="preloader">
	    <div id="status">
	    </div>
	</div>  
	-->
	<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ucsd-progsys.github.io/liquidhaskell-blog" id="blog-title-left-top">LiquidHaskell</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- <li class="dropdown">
                    <a href="#portfolioModal2" data-toggle="modal"><i class="fa fa-random" id="icon-top"></i></a>
                <ul class="dropdown-menu"></ul>
                </li>-->
                
                <li><a href="https://ucsd-progsys.github.io/liquidhaskell-blog/blog.html">Blog</a></li>
                <li><a href="http://goto.ucsd.edu:8090/index.html#?demo=TypesVLogic.hs" target="_blank">Demo</a></li>
                <li><a href="http://ucsd-progsys.github.io/lh-workshop" target="_blank">Tutorial</a></li>
                <li><a href="http://ucsd-progsys.github.io/liquidhaskell-tutorial" target="_blank">Book</a></li>
                <li><a href="https://ucsd-progsys.github.io/liquidhaskell-blog/about.html" target="_blank">About</a></li>
                <li><a href="http://www.github.com/ucsd-progsys/liquidhaskell" target="_blank"><i class="fa fa-twitter"></i>Download</a></li>
                <!--
                <li><a href="https://www.twitter.com/ranjitjhala" id="roundbutton" target="_blank"><i class="fa fa-twitter"></i>RanjitJhala</a></li>
                -->
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<!-- Portfolio Modals -->
    <div class="portfolio-modal modal fade" id="portfolioModal1" tabindex="-1" role="dialog" aria-hidden="true" style="padding-right:0px; overflow: hidden;">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <h1 class="font-style-inline-small-h1">Ranjit Jhala</h1>
                            <hr class="star-primary">
                            <img src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/ico.png" class="img-responsive img-centered" alt title>
                            <p class="font-style-inline-small">
                                <a href="https://www.twitter.com/ranjitjhala" target="_blank">follow me</a>. <br>
                                <a href="https://www.github.com/ucsd-progsys" target="_blank">    <i class="fa fa-github" id="spaceg-social-modal"></i> </a>
                                <a href="https://www.twitter.com/ranjitjhala" target="_blank"><i class="fa fa-twitter" id="spaceg-social-modal"></i> </a>
                                <a href="https://plus.google.com/u/0/106612421534244742464" target="_blank"> <i class="fa fa-google-plus" id="spaceg-social-modal"></i></a>
                            </p>
                            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Menu Modals Add New Sa.21.Feb.2015 03:22:25 -->
    <div class="portfolio-modal modal fade" id="portfolioModal2" tabindex="-1" role="dialog" aria-hidden="true" style="padding-right:0px; overflow: hidden;">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <h1 class="font-style-inline-small-h1">Ranjit Jhala</h1>
                            <hr class="star-primary">
                            <p class="font-style-inline-small">
                        <a href="https://www.twitter.com/ranjitjhala" target="_blank">follow</a>. <br>
                        <a href="https://www.github.com/ucsd-progsys" target="_blank">    <i class="fa fa-github" id="spaceg-social-modal"></i> </a>
                        <a href="https://www.twitter.com/ranjitjhala" target="_blank"><i class="fa fa-twitter" id="spaceg-social-modal"></i> </a>
                        <a href="https://plus.google.com/u/0/106612421534244742464" target="_blank"> <i class="fa fa-google-plus" id="spaceg-social-modal"></i></a>  <br>
                    <li><a href="https://ucsd-progsys.github.io/liquidhaskell-blog/index.html">Home</a></li>
                    <li><a href="https://ucsd-progsys.github.io/liquidhaskell-blog/about.html">About</a></li>
                    <li><a href="https://ucsd-progsys.github.io/liquidhaskell-blog/blog.html">Blog</a></li>
                    <li><a href="http://goto.ucsd.edu:8090/index.html#?demo=TypesVLogic.hs" target="_blank">Demo</a></li>
                    <li><a href="http://ucsd-progsys.github.io/lh-workshop" target="_blank">Tutorial</a></li>
                    <li><a href="http://ucsd-progsys.github.io/liquidhaskell-tutorial" target="_blank">Book</a></li>
                    <li><a href="http://www.github.com/ucsd-progsys/liquidhaskell" target="_blank"><i class="fa fa-twitter"></i>Download</a></li>
                            </p>

                            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


        <div id="content">
            <!-- Post Header -->
<header class="intro-header" style="background-image: url('https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/sea.jpg')" alt title>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Liquid Types vs. Floyd-Hoare Logic</h1>
                    
                    <span class="meta">
		    
			Posted by Ranjit Jhala
		    
			Oct 21, 2019
		    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

            <br>

            <div class="info">
              
                Tags: <a title="All pages tagged 'basic'." href="../../../../tags/basic.html">basic</a>
              
            </div>

            <br>
			            <p>Several folks who are experts in the program verification
literature have asked me some variant of the following question:</p>
<blockquote>
<p>How are <em>Liquid/Refinement</em> types different from <em>Floyd-Hoare logics</em>?</p>
</blockquote>
<p>This question always reminds me of <a href="https://yanniss.github.io/">Yannis Smaragdakis’</a> clever limerick:</p>
<blockquote>
<p>No idea is too obvious or dreary,</p>
<p>If appropriately expressed in type theory,</p>
<p>It’s a research advance,</p>
<p>That no one understands,</p>
<p>But they are all too impressed to be leery.</p>
</blockquote>
<p>That is, the above question can be rephrased as: why bother with
the hassle of encoding properties in <em>types</em> when good old-fashioned
<em>assertions</em>, <em>pre</em>- and <em>post</em>-conditions would do? Is it just a
marketing gimmick to make readers too impressed to be leery?</p>
<h2 id="the-problem-quantifiers">The Problem: Quantifiers</h2>
<p>The main <em>algorithmic</em> problem with classical Floyd-Hoare logic
is that to do useful things, you need to use <strong>universally quantified</strong>
logical formulas inside invariants, pre- and post-conditions.</p>
<p>Verification then proceeds by asking SMT solvers to check
<em>verification conditions</em> (VCs) over these quantified formulas.
While SMT solvers are marvelous technological artifacts, and I bow
to no one in my admiration of them, in reality, they work best on
formulas from a narrowly defined set of <em>decidable theories</em>.</p>
<p>In particular, they are notoriously (and justifiably!) fickle
when quizzed on VCs with quantifiers. Briefly, this is because
even if the solver “knows” the universally quantified fact:</p>
<pre><code>forall x. P(x)</code></pre>
<p>the solver doesn’t know which particular terms <code>e1</code>, <code>e2</code> or <code>e3</code>
to <strong>instantiate</strong> the fact at. That is, the solver doesn’t know
which <code>P(e1)</code> or <code>P(e2)</code> or <code>P(e3)</code> it should work with to prove
some given goal. At best, it can make some educated guesses, or
use hints from the user, but these heuristics can turn out to be
<a href="https://www.semanticscholar.org/paper/Trigger-Selection-Strategies-to-Stabilize-Program-Leino-Pit-Claudel/ca873df7c3172ab96dfc0d808e1654077c92064d">quite brittle</a> as the underlying logics
are undecidable in general. To make verification predictable,
we really want to ensure that the VCs remain decidable, and
to do so, we must steer clear of the precipice of quantification.</p>
<h2 id="the-solution-types">The Solution: Types</h2>
<p>The great thing about types, as any devotee will tell you,
is that the <em>compose</em>. Regrettably, that statement is only
comprehensible to believers. I prefer to think of it
differently: types <em>decompose</em>. To be precise:</p>
<blockquote>
<p><strong>Types <em>decompose</em> quantified assertions into quantifier-free refinements.</strong></p>
</blockquote>
<p>Let me make my point with some examples that show what verification
looks like when using Refinement Types (as implemented in <a href="https://github.com/ucsd-progsys/liquidhaskell">LiquidHaskell</a>) vs
Floyd-Hoare style contracts (as implemented in <a href="https://github.com/dafny-lang/dafny">Dafny</a>).</p>
<p>The goal of this exercise is to illustrate how types help
with verification, not to compare the tools LH and Dafny.
In particular, Dafny could profit from refinement types,
and LH could benefit from the many clever ideas embodied
within Dafny.</p>
<h2 id="example-1-properties-of-data">Example 1: Properties of Data</h2>
<p>Consider the following standard definition of a <code>List</code> datatype
in Dafny (left) and LH (right).</p>
<div class="row-fluid">
<div class="span12 pagination-centered">
<figure>
<img src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/why_types_1_1.png" height="200">
<figcaption>
A list data type in Dafny (L) and LiquidHaskell (R)
</figcaption>
</figure>
</div>
</div>
<p>(You can see the full definitions for <a href="https://rise4fun.com/Dafny/tkfQ">Dafny</a> and <a href="FIXME">LiquidHaskell</a>.)</p>
<h3 id="accessing-a-list">Accessing a list</h3>
<p>The two descriptions are more or less the same except for some
minor issues of concrete syntax. However, next consider the
respective implementations of a function to access the <code>ith</code>
element of a <code>List</code>. We also pass in a <code>def</code>ault value returned
when the index <code>i</code> is <em>invalid</em>.</p>
<div class="row-fluid">
<div class="span12 pagination-centered">
<figure>
<img src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/why_types_1_2.png" height="200">
<figcaption>
Accessing the i-th element of a list in Dafny(L) and LiquidHaskell(R)
</figcaption>
</figure>
</div>
</div>
<p>It is (usually) silly to access lists in this fashion.
I use this example merely to illustrate the common case
of defining a <em>container</em> structure (here, <code>List</code>) and
then <em>accessing</em> its contents (here, <code>ith</code>).
As such, we’d like to <em>specify</em> that the value returned
by the <code>ith</code> element is indeed in the container <em>or</em> is
the <code>def</code>ault.</p>
<p><strong>Floyd-Hoare Logic</strong></p>
<p>With classical Floyd-Hoare logic, as shown in the Dafny listing
on the left, we must spell out the specification quite explicitly.
The programmer must write an <code>elements</code> function that describes
the <em>set</em> of values in the container, and then the <em>post-condition</em>
of <code>ith</code> states that the <code>res</code> is either in that set or the default.</p>
<p>While this specification seems simple enough, we are already on
dicey terrain: how are we to encode the semantics of the
user-defined function <code>elements</code> to the SMT solver?
In the classical Floyd-Hoare approach, we must use a
<em>quantified invariant</em> of the form:</p>
<pre><code>   elements(Nil) = empty 
&amp;&amp; forall h t :: elements(Cons(h, t)) = {h} + elements(t)</code></pre>
<p>Thanks to the ingenuity of <a href="https://en.wikipedia.org/wiki/Greg_Nelson_(computer_scientist)">Greg Nelson</a> who invented the notion
of <em>triggers</em> and of <a href="http://leino.science/">Rustan Leino</a> and many others, who devised
ingenious heuristics for using them, Dafny handles the quantifier
calmly to verify the above specification for <code>ith</code>.
However, we are not always so fortunate: it frightfully easy
to run into quantifier-related problems with user-defined
functions, as we will see in due course.</p>
<p><strong>Liquid/Refinement Types</strong></p>
<p>In contrast, the liquid/refinement version is quite spare:
there <em>is</em> no extra specification beyond the code. Surely
there must be some mistake? Look again: the <em>type signature</em>
says everything we need:</p>
<blockquote>
<p>If you call <code>ith</code> with a list of <code>a</code> values and a default <code>a</code> value
then you get an <code>a</code> value”.</p>
</blockquote>
<p>That is <em>parametricity</em> removes the overhead of using an
explicit <code>elements</code> function.</p>
<h3 id="building-a-list">Building a list</h3>
<p>Next, lets extend our example to illustrate the common
situation where we want some <em>invariant</em> to be true for
<em>all</em> the values in a container. To this end, let us
write a function <code>mkList</code> that <em>builds</em> a container
with values <code>k+1</code>,…,<code>k+n</code> and then <em>test</em> that when
<code>k</code> is non-negative, any arbitrarily chosen value from
the container is indeed strictly positive.</p>
<div class="row-fluid">
<div class="span12 pagination-centered">
<figure>
<img src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/why_types_1_3.png" height="200">
<figcaption>
Building and accessing a list in Dafny (L) and LiquidHaskell(R)
</figcaption>
</figure>
</div>
</div>
<p>The code in Dafny and LH is more or less the same, except
for one crucial difference.</p>
<p><strong>Floyd-Hoare Logic</strong></p>
<p>Recall that the specification for <code>ith(pos, i, 1)</code> states
that the returned value is <em>some</em> element of the container
(or <code>1</code>). Thus, to verify the <code>assert</code> in <code>testPosN</code> using
classical Floyd-Hoare logic, we need a way to specify that
<em>every</em> element in <code>pos</code> is indeed strictly positive.
With classical program logics, the only way to do so is to
use a <em>universally quantified</em> post-condition, highlighted
in blue:</p>
<p>“<strong>for all</strong> <code>v</code> <em>if</em> <code>v</code> is in the elements of the <code>res</code>ult, <em>then</em> <code>v</code> is greater than <code>k</code>”</p>
<p><strong>Liquid/Refinement Types</strong></p>
<p>Regardless of my personal feelings about quantifiers,
we can agree that the version on the right is simpler
as types make it unnecessary to mention <code>elements</code> or
<code>forall</code>. Instead, LH <em>infers</em></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mkList ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> k<span class="op">:</span><span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">List</span> {v<span class="op">:</span><span class="dt">Int</span> <span class="op">|</span> k <span class="op">&lt;</span> v}</span></code></pre></div>
<p>That is, that the output type of <code>mkList</code> is a
list of values <code>v</code> that are all greater than <code>k</code>.
The scary <em>forall</em> has been replaced by the friendly
<em>type constructor</em> <code>List</code>. In other words, types
allow us to <em>decompose</em> the monolithic universally
quantified invariant into:</p>
<ol type="1">
<li>a <em>quantifier-free</em> refinement <code>k &lt; v</code>, and</li>
<li>a type <em>constructor</em> that implicitly “quantifies” over the container’s elements.</li>
</ol>
<h3 id="lesson-decomposition-enables-inference">Lesson: Decomposition Enables Inference</h3>
<p>Am I cheating? After all, what prevents Dafny from
<em>inferring</em> the same post-condition as LH?</p>
<p>Once again, quantifiers are the villain.</p>
<p>There have been many decades worth of papers on the
topic of inferring quantified invariants, but save
some nicely circumscribed use-cases these methods
turn out to be rather difficult to get working
efficiently and predictably enough to be practical.
In contrast, once the quantifiers are decomposed
away, even an extremely basic approach called
<a href="http://www-verimag.imag.fr/~graf/PAPERS/GrafSaidi97.pdf">Monomial Predicate Abstraction</a>,
or more snappily, <a href="https://dl.acm.org/citation.cfm?id=730008">Houdini</a>, suffices
to infer the above liquid type.</p>
<h2 id="example-2-properties-of-structures">Example 2: Properties of Structures</h2>
<p>Recall that when discussing the user-defined <code>elements</code> function above,
I had issued some dark warnings about quantifier-related problems that
arise from user-defined functions. Allow me to explain with another
simple example, that continues with the <code>List</code> datatype defined above.</p>
<p>(You can see the full definitions for <a href="https://rise4fun.com/Dafny/nphIv">Dafny</a> and <a href="FIXME">LiquidHaskell</a>.)</p>
<h3 id="specifying-a-size-function">Specifying a <code>size</code> Function</h3>
<p>Lets write the usual <em>recursive</em> function that computes the <code>size</code>
of a list. The definitions are mostly identical, except for the green
<code>measure</code> highlight that we will discuss below.</p>
<div class="row-fluid">
<div class="span12 pagination-centered">
<figure>
<img src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/why_types_2_1.png" height="200">
<figcaption>
A function defining the size of a list in Dafny (L) and LiquidHaskell (R)
</figcaption>
</figure>
</div>
</div>
<p><strong>Floyd-Hoare Logic</strong></p>
<p>SMT solvers are restricted to a set of <em>ground</em> theories and hence,
do not “natively” understand user-defined functions. Instead, the
verifer must <em>teach</em> the SMT solver how to reason about formulas (VCs)
containing uses of user-defined functions like <code>size</code>.
In the classical Floyd-Hoare approach, this is done by converting
the definition of <code>size</code> into a universally quantified <em>axiom</em> like:</p>
<pre><code>size Nil == 0  &amp;&amp; forall h, t :: size (Cons h t) = 1 + size t</code></pre>
<p>A quantifier! By the pricking of my thumbs, something wicked this way comes…</p>
<p><strong>Liquid/Refinement Types</strong></p>
<p>With a more <em>type-centric</em> view, we can think of the recursive
function <code>size</code> as a way to <em>decorate</em> or <em>refine</em> the types of
the <em>data constructors</em>. So, when you write the definition in
the green box above, specifically when you add the <code>measure</code>
annotation, the function is converted to <em>strengthened</em>
versions for the types of the constructors <code>Nil</code> and <code>Cons</code>,
so its as if we had defined the list type as two constructor
functions</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">List</span> a <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Cons</span><span class="ot"> ::</span> h<span class="op">:</span>a <span class="ot">-&gt;</span> t<span class="op">:</span><span class="dt">List</span> a <span class="ot">-&gt;</span> {v<span class="op">:</span><span class="dt">List</span> a <span class="op">|</span> size v <span class="op">==</span> <span class="dv">1</span> <span class="op">+</span> size t}</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Nil</span><span class="ot">  ::</span> {v<span class="op">:</span><span class="dt">List</span> a <span class="op">|</span> size v <span class="op">==</span> <span class="dv">0</span>} </span></code></pre></div>
<p>That is, the bodies of the measures get translated to refinements
on the output types of the corresponding constructors. After this,
the SMT solver “knows nothing” about the semantics of <code>size</code>, except
that it is a function. In logic-speak, <code>size</code> is <strong>uninterpreted</strong>
in the refinement, and there are no quantified axioms. That is, we
choose to keep SMT solver blissfully ignorant about the semantics
of <code>size</code>. How could this possibly be a good thing?</p>
<h3 id="verifying-the-size-of-a-list">Verifying the <code>size</code> of a List</h3>
<p>Next, lets see what happens when we write a simple test that builds
a small list with two elements and <code>assert</code>s that the lists <code>size</code>
is indeed <code>2</code>:</p>
<div class="row-fluid">
<div class="span12 pagination-centered">
<figure>
<img src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/img/why_types_2_2.png" height="200">
<figcaption>
Verifying the size of a list in Dafny (L) and LiquidHaskell (R)
</figcaption>
</figure>
</div>
</div>
<p><strong>Floyd-Hoare Logic</strong></p>
<p>To get Dafny to verifier to sign off on the <code>assert (size(pos) == 2)</code>
we have to add a mysterious <em>extra assertion</em> that checks the size of
the intermediate value <code>Cons (1, Nil)</code>. (Without it, verification fails.)</p>
<p>Huh? Pesky quantifiers.</p>
<p>The SMT solver doesn’t know <em>where</em> to instantiate the <code>size</code> axom.
In this carefully chosen, but nevertheless simple situation, Dafny’s
instantiation heuristics come up short. I had to help them along by
guessing this intermediate assertion, which effectively “adds” the
fact that the size of the intermediate list is 1, thereby letting
the SMT solver prove the second assertion.</p>
<p><strong>Liquid/Refinement Types</strong></p>
<p>In contrast, with types, the solver is able to verify the code without
batting an eyelid. But how could it possibly do so even though we kept
it ignorant of the semantics of <code>size</code>?</p>
<p>Because types decompose reasoning. In particular, here, the measure
and constructor trick lets us <em>factor reasoning about <code>size</code> into the type system</em>.</p>
<p>In particular, LH internally views the code for <code>test</code> in A-Normal Form
which is a fancy way of saying, by introducing temporary variables
for all sub-expressions:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>test x1 <span class="ot">=</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">let</span> tmp0 <span class="ot">=</span> <span class="dt">Nil</span>                </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>       tmp1 <span class="ot">=</span> <span class="dt">Cons</span> x1 tmp0 </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>       pos  <span class="ot">=</span> <span class="dt">Cons</span>  0 tmp1</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">in</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      assert (size pos <span class="op">==</span> <span class="dv">2</span>)</span></code></pre></div>
<p>And now, just by the rules of type checking, and applying the types
of the constructors, it deduces that:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">   tmp0 ::</span> {size tmp0 <span class="op">==</span> <span class="dv">0</span>}</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ot">   tmp1 ::</span> {size tmp1 <span class="op">==</span> <span class="dv">1</span> <span class="op">+</span> size tmp0}</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ot">   pos  ::</span> {size pos  <span class="op">==</span> <span class="dv">1</span> <span class="op">+</span> size tmp1}</span></code></pre></div>
<p>which lets the SMT solver prove that <code>size pos == 2</code> without
requiring any axiomatic description of <code>size</code>. This simple
<code>measure</code> method goes a very long way in specifying and
verifying <a href="http://goto.ucsd.edu/~rjhala/papers/real_world_liquid.pdf">lots of properties</a>.</p>
<h3 id="lesson-decomposition-enables-type-directed-instantiation">Lesson: Decomposition Enables Type-Directed Instantiation</h3>
<p>I’d like to emphasize again that this trick was enabled
by the type-centric view: encode the function semantics
in <em>data constructors</em>, and let the type checking (or VC
generation) do the <em>instantiation</em>.</p>
<p>It could easily by incorporated inside and work together
with axioms in Floyd-Hoare based systems like Dafny.
Of course, this approach is limited to a restricted class
of functions – roughly, case-splits over a single data type’s
constructors – but we can generalize the method quite
a bit using the idea of <a href="https://arxiv.org/abs/1711.03842">logical evaluation</a>.</p>
<h2 id="summary">Summary</h2>
<p>To sum up, we saw two examples where taking a type-centric view
made verification more <em>ergonomic</em>, essentially by <em>factoring</em>
reasoning about quantifiers into the type system.</p>
<ul>
<li><p>In the first case, when reasoning about <em>data</em> in containers,
the polymorphic type constructor <code>List</code> provided an natural
way to reason about the fact that <em>all</em> elements in a container
satisfied some property.</p></li>
<li><p>In the second case, when reasoning about the <em>structure</em>
of the container via a recursive function, the types of
the data constructors allowed us to factor the instantiation
of properties of <code>size</code> at places where the list was constructed
(and dually, not shown, destructed) without burdening the SMT
solver with any axioms and the pressure of figuring out where
to instantiate them.</p></li>
</ul>
<p>To conclude I’d like to reiterate that the point is <em>not</em>
that types and program logics are at odds with each other.
Instead, the lesson is that while classical
Floyd-Hoare logic associates invariants with <em>program</em>
positions, Liquid/Refinement types are a <em>generalization</em>
that additionally let you associate invariants with
<em>type</em> positions, which lets us exploit</p>
<ul>
<li>types as a program logic, and</li>
<li>syntax-directed typing rules as a decision procedure,</li>
</ul>
<p>that, in many common situations, simplify verification by
decomposing proof obligations (VCs) into simple, quantifier-free,
SMT-friendly formulas. As you might imagine, the benefits
are magnified when working with higher-order functions,
e.g. <code>map</code>-ing or <code>fold</code>-ing over containers…</p>
<h3 id="acknowledgments">Acknowledgments</h3>
<p>Huge thanks to
<a href="http://leino.science/">Rustan Leino</a>,
<a href="https://cseweb.ucsd.edu/~npolikarpova/">Nadia Polikarpova</a>,
<a href="http://cseweb.ucsd.edu/~daricket/">Daniel Ricketts</a>,
<a href="https://twitter.com/hillelogram">Hillel Wayne</a>, and
<a href="https://twitter.com/zizzivon">Zizz Vonnegut</a>
for patiently answering my many questions about Dafny!</p>
                <hr>
                <ul class="pager">
                    
                    
                </ul>

                <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        this.page.url        = 'https://ucsd-progsys.github.io/liquidhaskell-blog/2019/10/20/why-types.lhs';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2019/10/20/why-types.lhs';           // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        s.src = '//liquidhaskell.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


            </div>
        </div>
    </div>
</article>

        </div>
        <div id="footer">
        </div>
      <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="https://ucsd-progsys.github.io/liquidhaskell-blog/feed.xml" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/ranjitjhala" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://plus.google.com/u/0/106612421534244742464" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/ucsd-progsys" target="_blank">
                            <span class="fa-stack fa-lg">

                              <i class="fa fa-arrow-circle-o-down"></i>
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
		    
                </ul>
                <p class="copyright text-muted">
                
                  Copyright &copy; Ranjit Jhala 2016-17.
                
                  Generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>,
                  template by <a href="http://lucumr.pocoo.org">Armin Ronacher</a>,
                  suggest improvements <a href="https://github.com/ucsd-progsys/liquidhaskell-blog/">here</a>.
                </p>
            </div>
        </div>
    </div>
</footer>


<!-- jQuery -->
<script src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/js/jquery.min.js"></script>
<script src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/js/spaceg.stylesheets.min.js"></script>
<script src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/js/bootstrap.min.js"></script>
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
<script src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/js/anim.js"></script>
<script src="https://ucsd-progsys.github.io/liquidhaskell-blog/static/js/scripts.js"></script>

    </body>
</html>
